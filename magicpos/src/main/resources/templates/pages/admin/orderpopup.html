<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/admin/main_layout}"
      th:inline="javascript">

<body layout:fragment="content">
    <div class="order-status-container">
        <!-- 헤더 -->
      <div class="order-status-header">
      <a href="/admin/orderpopup" class="number-tab1"
        th:classappend="${requestURI == '/admin/orderpopup'} ? 'active-tab'">
          주문현황 <span th:text="${#numbers.formatInteger(orderCount, 2)}">00</span>
      </a>

      <a href="/admin/orderpopup/preparing" class="number-tab2"
        th:classappend="${requestURI == '/admin/orderpopup/preparing'} ? 'active-tab'">
          준비중 <span th:text="${#numbers.formatInteger(preparingCount, 2)}">00</span>
      </a>
      </div>

        <!-- 주문 리스트 -->
        <div class="order-list">
            <!-- 주문 없을 때 -->
            <div th:if="${#lists.isEmpty(orderList)}" class="no-orders">주문이 없습니다.</div>

            <!-- 주문 있을 때 -->
            <div th:each="order : ${orderList}" class="order-card">
              <!-- 주문 카드 내부 -->
              <div class="order-card-inner">
                <!-- 좌측 좌석 정보 -->
                <div class="order-time-box">
                    <div class="seat-no" th:text="${order.seatId}">17</div>
                    <div class="action-btn">판매하기</div>

                </div>

                <!-- 우측 주문 상세 -->
              <div class="order-detail-box">
                <span class="menu-names" th:text="${menuNamesMap[order.no]}">치킨마요 덮밥, 돈까스 김치나베</span>

                <div class="status-row1">
                  <div class="memo" th:text="${order.message}">맛있게 만들어주세요~</div>
                  <span class="sell-cancel" th:attr="data-order-no=${order.no}">판매취소</span>
                </div>
                <div class="status-row2">
                <div class="price-box">
                  <span class="price" th:text="${#numbers.formatInteger(order.totalPrice, 3, 'COMMA')} + '원'">0원</span>
                  <span class="paytype" th:text="'(' + ${order.payment} + ')'">(card)</span>
                </div>
                  <div class="status-badges">
                    <span class="badge preparing"
                          th:onclick="'updateStatus(' + ${order.no} + ', 1, this)'"
                          th:classappend="${order.orderStatus == 1} ? ' active'">
                      준비중
                    </span>
                    <span class="badge complete"
                          th:classappend="${order.orderStatus == 2} ? ' active'"
                          th:onclick="'updateStatus(' + ${order.no} + ', 2, this)'">
                      전달완료
                    </span>
                  </div>
                </div>
              </div>
              </div>
              <div class="order-card-footer">
                <div class="wait-time" th:if="${waitTime[order.no] != null}" th:classappend="${waitTime[order.no] > 30} ? ' red-text'">
                  <span th:text="'⏱ ' + ${waitTime[order.no]} + '분 경과'">00분 경과</span>
                </div>
                <span class="time" th:text="${#dates.format(order.orderTime, 'MM/dd HH:mm')}">07/01 16:50</span>
              </div>
        </div>
    </div>
</div>
  <script>
      // 주문현황 수량 갱신
      function refreshCounts() {
      fetch('/orders/status/counts')
          .then(res => res.json())
          .then(data => {
          document.querySelector('.number-tab1 span').textContent =
              data.orderCount.toString().padStart(2, '0');
          document.querySelector('.number-tab2 span').textContent =
              data.prepareCount.toString().padStart(2, '0');
          });
      }
  </script>
  <script>
  function closeCancelModal(orderNo) {
    const modal = document.getElementById(`cancel-modal-${orderNo}`);
    if (modal) {
      modal.remove(); // 아예 DOM에서 삭제해도 됨
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.sell-cancel').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const orderNo = btn.dataset.orderNo;

        fetch(`/admin/cancel/${orderNo}`)
          .then(res => res.text())
          .then(html => {
            // 이미 열려 있는 모달 있으면 먼저 제거
            const existing = document.getElementById(`cancel-modal-${orderNo}`);
            if (existing) existing.remove();

            // 응답 HTML을 body에 추가
            document.body.insertAdjacentHTML("beforeend", html);

            // 모달 띄우기
            const modal = document.getElementById(`cancel-modal-${orderNo}`);
            if (modal) modal.style.display = 'block';
          });
      });
    });
  });
</script>

<script>
// 페이지 로딩 시 수량 나옴
document.addEventListener("DOMContentLoaded", () => {
refreshCounts(); // 상태 숫자 최신화
});

// 준비중, 전달완료 상태 변경
function updateStatus(orderNo, status, el) {
    console.log('orderNo:', orderNo, 'status:', status);
    // const data = {
        //   no: orderNo,
        //   orderStatus: status,
        // }
        const formData = new FormData();    // Content-Type: multipart/form-data
        formData.append("no", orderNo);
        formData.append("orderStatus", status);
        fetch('/orders/status', {
            method: 'POST',
            // JSON
            // headers: {
                //   'Content-Type': 'application/json' // JSON 형식으로 전송
                // },
                // body: JSON.stringify(data) // 객체를 JSON 문자열로 변환  -> '{"no":1,"orderStatus":2}'
                // FormData
                body: formData // FormData 객체를 전송
            })
            .then(res => res.text())
            .then(data => {
                if (data === 'ok') {
                    refreshCounts();
                    if (status == 2) {
                        // 전달완료 → 카드 제거
                        el.closest('.order-card').style.display = 'none';
                    } else {
                        // 준비중 → 강조 표시
                        const badges = el.parentElement.querySelectorAll('.badge');
                        badges.forEach(b => b.classList.remove('active'));
                        el.classList.add('active');
                    }
                } else {
                    alert("상태 변경 실패!");
                }
            });
        }
</script>
<script>
    document.body.addEventListener("click", (e) => {
    const target = e.target.closest(".sell-cancel");
    if (target) {
        console.log("✅ 판매취소 클릭됨");
        document.getElementById("cancel-modal").style.display = "flex";
    }
    });

    function closeCancelModal() {
        document.getElementById("cancel-modal").style.display = "none";
    }
</script>
</body>
</html>